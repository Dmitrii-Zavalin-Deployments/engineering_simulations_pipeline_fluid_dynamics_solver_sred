name: Fluid Dynamics Calculations Pipeline

on:
  push:
    branches:
      - "**" # Triggers on any branch
  workflow_dispatch:

jobs:
  fluid_dynamics_simulation:
    runs-on: ubuntu-latest

    # Define common file paths for clarity and easier updates
    env:
      ORIGINAL_INPUT_FILE: ${{ github.workspace }}/data/testing-input-output/fluid_simulation_input.json
      # New temporary file path for pre-processed input
      TEMP_SOLVER_INPUT_FILE: ${{ github.workspace }}/temp/solver_input.json
      FINAL_OUTPUT_FILE: ${{ github.workspace }}/data/testing-input-output/navier_stokes_results.json

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13" # Ensure consistent Python version

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest numpy # Explicitly install common scientific dependencies
        # Install jq for JSON validation
        sudo apt-get update && sudo apt-get install -y jq

    - name: List installed packages (Debugging)
      run: pip list
      
    - name: Delete Previous Fluid Simulation Input JSON
      run: |
        if [ -f "$ORIGINAL_INPUT_FILE" ]; then
          rm "$ORIGINAL_INPUT_FILE"
          echo "üóëÔ∏è Deleted previous fluid_simulation_input.json file."
        else
          echo "‚ÑπÔ∏è No previous fluid_simulation_input.json found‚Äîproceeding with new generation."
        fi
    
    - name: Make `download_from_dropbox.sh` Executable
      run: chmod +x src/download_from_dropbox.sh

    - name: Download Simulation Files from Dropbox
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: src/download_from_dropbox.sh

    # Ensure original input file `fluid_simulation_input.json` exists before pre-processing
    - name: Verify Original Input File Exists
      run: |
        if [ ! -f "$ORIGINAL_INPUT_FILE" ]; then
          echo "‚ùå Error: Original input file fluid_simulation_input.json is missing at $ORIGINAL_INPUT_FILE!"
          exit 1
        fi
        echo "‚úÖ Original input file fluid_simulation_input.json found at $ORIGINAL_INPUT_FILE."

    # Debugging: Print full directory tree before running pre-processor
    - name: Debugging - List All Files in Repository Before Pre-processing
      run: ls -R "${GITHUB_WORKSPACE}"

    # --- NEW STEP: Create Temporary Directory for Solver Input ---
    - name: Create temp directory for solver input
      run: mkdir -p "$(dirname "$TEMP_SOLVER_INPUT_FILE")"

    # --- NEW STEP: Run the Pre-processing Script ---
    - name: Run Fluid Simulation Pre-processor
      run: |
        # Added PYTHONPATH to allow Python to find modules within the 'src' directory for internal imports
        PYTHONPATH="${GITHUB_WORKSPACE}/src" python "${GITHUB_WORKSPACE}/src/pre_process_input.py" "$ORIGINAL_INPUT_FILE" "$TEMP_SOLVER_INPUT_FILE"
        echo "‚úÖ Pre-processing completed. Temporary solver input generated at $TEMP_SOLVER_INPUT_FILE."
    
    # Verify the temporary file exists after pre-processing
    - name: Verify Temporary Solver Input File Exists
      run: |
        if [ ! -f "$TEMP_SOLVER_INPUT_FILE" ]; then
          echo "‚ùå Error: Temporary solver input file is missing at $TEMP_SOLVER_INPUT_FILE!"
          exit 1
        fi
        echo "‚úÖ Temporary solver input file found at $TEMP_SOLVER_INPUT_FILE."

    # --- MODIFIED STEP: Run the Main Navier-Stokes Solver (uses temp file) ---
    - name: Run Main Navier-Stokes Solver
      run: |
        # Corrected PYTHONPATH to allow Python to find modules within the 'src' directory
        PYTHONPATH="${GITHUB_WORKSPACE}/src" python "${GITHUB_WORKSPACE}/src/main_solver.py" "$TEMP_SOLVER_INPUT_FILE" "$FINAL_OUTPUT_FILE"
        echo "‚úÖ Main Navier-Stokes simulation executed successfully."

    # Ensure output file exists after execution
    - name: Verify Output File Exists
      run: |
        if [ ! -f "$FINAL_OUTPUT_FILE" ]; then
          echo "‚ùå Error: Simulation output file not found at $FINAL_OUTPUT_FILE!"
          exit 1
        fi
        echo "‚úÖ Output file navier_stokes_results.json found at $FINAL_OUTPUT_FILE."

    - name: Debugging - Show Output File Contents
      run: |
        echo "üîç Output File Content Preview:"
        cat "$FINAL_OUTPUT_FILE"

    # Validate JSON Format Before Committing
    - name: Verify JSON Format Before Commit
      run: |
        if jq empty "$FINAL_OUTPUT_FILE"; then
          echo "‚úÖ JSON output is valid."
        else
          echo "‚ùå Error: JSON output is malformed!"
          exit 1
        fi

    # --- Commit and Push Updated Simulation Results (If Tests Pass) ---
    # - name: Commit and Push Simulation Results JSON
    #   env:
    #     GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
    #     GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
    #   run: |
    #     git config --global user.name "${GIT_USER_NAME}"
    #     git config --global user.email "${GIT_USER_EMAIL}"

    #     cd "$GITHUB_WORKSPACE"
    #     RESULTS_FILE="data/testing-input-output/navier_stokes_results.json" # Use RESULTS_FILE variable here if defined above

    #     if [ -s "$RESULTS_FILE" ]; then
    #       git add "$RESULTS_FILE"
    #       git status
          
    #       if git diff --cached --quiet; then
    #         echo "‚úÖ No changes to commit in $RESULTS_FILE!"
    #       else
    #         git commit -m "Auto-update: Added latest Navier-Stokes simulation result"
    #         git push origin HEAD
    #       fi
    #     else
    #       echo "‚ùå No valid simulation result file detected ($RESULTS_FILE is empty or missing), skipping commit."
    #     fi

    - name: Make `upload_to_dropbox.sh` Executable
      run: chmod +x src/upload_to_dropbox.sh

    - name: Debug Before Dropbox Upload
      run: |
        echo "üîç Checking directory structure before upload..."
        ls -R $GITHUB_WORKSPACE

    - name: Upload Fluid Simulation Input to Dropbox
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: src/upload_to_dropbox.sh