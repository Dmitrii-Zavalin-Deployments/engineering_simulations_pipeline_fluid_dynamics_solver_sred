name: Fluid Dynamics Calculations Pipeline

on:
  push:
    branches:
      - "**" # Triggers on any branch
  workflow_dispatch:

jobs:
  fluid_dynamics_simulation:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: ${{ github.workspace }}/src  # ‚úÖ Ensures src/ imports are recognized
      ORIGINAL_INPUT_FILE: ${{ github.workspace }}/data/testing-input-output/fluid_simulation_input.json
      OUTPUT_RESULTS_BASE_DIR: ${{ github.workspace }}/data/testing-output-run 
      TEMP_SOLVER_INPUT_FILE: ${{ github.workspace }}/temp/solver_input.json

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python & Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest numpy jq
        echo "‚úÖ Python and dependencies installed."

    - name: Clean Previous Input & Download Files
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: |
        rm -f "$ORIGINAL_INPUT_FILE" && echo "üóëÔ∏è Cleaned previous input (if existed)." || echo "‚ÑπÔ∏è No previous input to clean."
        chmod +x src/download_from_dropbox.sh
        src/download_from_dropbox.sh
        [ -f "$ORIGINAL_INPUT_FILE" ] && echo "‚úÖ Original input file found." || { echo "‚ùå Error: Original input file missing!"; exit 1; }

    - name: Run Pre-processor (Generate cell_indices and structured input)
      run: |
        mkdir -p "$(dirname "$TEMP_SOLVER_INPUT_FILE")"
        python "${GITHUB_WORKSPACE}/src/pre_process_input.py" "$ORIGINAL_INPUT_FILE" "$TEMP_SOLVER_INPUT_FILE"

        # Verify the pre-processed file exists
        [ -f "$TEMP_SOLVER_INPUT_FILE" ] && echo "‚úÖ Pre-processing completed." || { echo "‚ùå Error: solver_input.json not created!"; exit 1; }

        # Sanity check: must include cell_indices
        if ! grep -q "cell_indices" "$TEMP_SOLVER_INPUT_FILE"; then
          echo "‚ùå Error: Preprocessed input missing 'cell_indices'. Did preprocessing run correctly?"
          cat "$TEMP_SOLVER_INPUT_FILE"
          exit 1
        fi

    - name: Run Main Solver
      run: |
        rm -rf "$OUTPUT_RESULTS_BASE_DIR"
        mkdir -p "$OUTPUT_RESULTS_BASE_DIR"
        python "${GITHUB_WORKSPACE}/src/main_solver.py" "$TEMP_SOLVER_INPUT_FILE" "$OUTPUT_RESULTS_BASE_DIR"
        echo "‚úÖ Main solver executed."

    - name: Verify Output & Validate JSON
      run: |
        ACTUAL_OUTPUT_DIR="$OUTPUT_RESULTS_BASE_DIR/navier_stokes_output"
        [ -d "$ACTUAL_OUTPUT_DIR" ] && echo "‚úÖ Output directory found." || { echo "‚ùå Error: Output directory missing!"; exit 1; }
        [ -f "$ACTUAL_OUTPUT_DIR/config.json" ] && echo "‚úÖ config.json found." || { echo "‚ùå Error: config.json not found!"; exit 1; }
        [ -f "$ACTUAL_OUTPUT_DIR/mesh.json" ] && echo "‚úÖ mesh.json found." || { echo "‚ùå Error: mesh.json not found!"; exit 1; }
        [ -d "$ACTUAL_OUTPUT_DIR/fields" ] && echo "‚úÖ fields directory found." || { echo "‚ùå Error: 'fields' directory missing!"; exit 1; }

        echo "üîç Directory Content:"
        ls -R "$ACTUAL_OUTPUT_DIR"

        jq empty "$ACTUAL_OUTPUT_DIR/config.json" || { echo "‚ùå config.json is malformed!"; exit 1; }

        FIRST_SNAPSHOT="$ACTUAL_OUTPUT_DIR/fields/step_0000.json"
        if [ -f "$FIRST_SNAPSHOT" ]; then
          jq empty "$FIRST_SNAPSHOT" || { echo "‚ùå First snapshot is malformed!"; exit 1; }
        else
          echo "‚ÑπÔ∏è No initial snapshot found (may be expected for short runs)."
        fi

    - name: Run Tests
      run: |
        ACTUAL_OUTPUT_DIR="$OUTPUT_RESULTS_BASE_DIR/navier_stokes_output"
        echo "üîç FULL_OUTPUT_DIR=$ACTUAL_OUTPUT_DIR"
        echo "üîç RESTARTED_OUTPUT_DIR=$ACTUAL_OUTPUT_DIR"

        pytest tests/ --verbose -ra

    - name: Upload Results to Dropbox
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        UPLOAD_DIR: ${{ env.OUTPUT_RESULTS_BASE_DIR }}/navier_stokes_output 
      run: |
        chmod +x src/upload_to_dropbox.sh
        echo "üîç Uploading contents of: $UPLOAD_DIR"
        ls -R "$UPLOAD_DIR"
        src/upload_to_dropbox.sh "$UPLOAD_DIR"



