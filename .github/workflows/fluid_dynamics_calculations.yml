# .github/workflows/fluid_dynamics_calculations.yml

name: Fluid Dynamics Calculations Pipeline

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  fluid_dynamics_simulation:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: ${{ github.workspace }}  # ‚úÖ Updated to include repo root for simulation module
      ORIGINAL_INPUT_FILE: ${{ github.workspace }}/data/testing-input-output/fluid_simulation_input.json
      OUTPUT_RESULTS_BASE_DIR: ${{ github.workspace }}/data/testing-output-run
      THRESHOLD_REPORT_PATH: ${{ github.workspace }}/data/testing-input-output/threshold_report.json

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python & Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest numpy jsonschema jq
        echo "‚úÖ Python and dependencies installed."

    - name: Validate Threshold Configuration
      run: |
        echo "üîç Running threshold schema validation..."
        python tools/validate_thresholds.py
        if [ -f "$THRESHOLD_REPORT_PATH" ]; then
          cat "$THRESHOLD_REPORT_PATH"
          echo "‚úÖ Threshold validation completed."
        else
          echo "‚ö†Ô∏è Threshold report not found at $THRESHOLD_REPORT_PATH"
        fi


    - name: Clean Previous Input & Download Files
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: |
        rm -f "$ORIGINAL_INPUT_FILE" && echo "üóëÔ∏è Cleaned previous input (if existed)." || echo "‚ÑπÔ∏è No previous input to clean."
        chmod +x src/download_from_dropbox.sh
        src/download_from_dropbox.sh
        [ -f "$ORIGINAL_INPUT_FILE" ] && echo "‚úÖ Original input file found." || { echo "‚ùå Error: Original input file missing!"; exit 1; }

    - name: Run Main Solver
      run: |
        rm -rf "$OUTPUT_RESULTS_BASE_DIR"
        mkdir -p "$OUTPUT_RESULTS_BASE_DIR"
        python "${GITHUB_WORKSPACE}/src/main_solver.py" "$ORIGINAL_INPUT_FILE" "$OUTPUT_RESULTS_BASE_DIR"
        echo "‚úÖ Main solver executed."

    - name: Run Tests
      run: |
        ACTUAL_OUTPUT_DIR="$OUTPUT_RESULTS_BASE_DIR/navier_stokes_output"
        echo "üîç FULL_OUTPUT_DIR=$ACTUAL_OUTPUT_DIR"
        echo "üîç RESTARTED_OUTPUT_DIR=$ACTUAL_OUTPUT_DIR"
        pytest -s tests/ --verbose -ra

    - name: Upload Results to Dropbox
      env:
        APP_KEY: ${{ secrets.APP_KEY }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        UPLOAD_DIR: ${{ env.OUTPUT_RESULTS_BASE_DIR }}/navier_stokes_output
      run: |
        chmod +x src/upload_to_dropbox.sh
        echo "üîç Uploading contents of: $UPLOAD_DIR"
        ls -R "$UPLOAD_DIR"
        src/upload_to_dropbox.sh "$UPLOAD_DIR"



